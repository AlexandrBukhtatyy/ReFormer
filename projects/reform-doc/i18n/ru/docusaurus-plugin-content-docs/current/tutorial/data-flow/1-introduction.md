---
sidebar_position: 1
---

# Введение в Data Flow

Управление полным жизненным циклом данных формы от загрузки до сохранения.

## Что такое Data Flow?

Data Flow управляет тем, как данные движутся через жизненный цикл вашей формы:

- **Загрузка** - Загрузка начальных данных из API или хранилища
- **Автосохранение** - Автоматическое сохранение прогресса
- **Управление черновиками** - Создание, загрузка и управление черновиками
- **Сброс/Очистка** - Возврат формы в исходное или пустое состояние
- **Предзаполнение** - Предзаполнение из внешних источников (профиль пользователя)
- **Преобразование** - Преобразование данных между форматами

## Почему управлять Data Flow?

Вместо ручной обработки каждой операции с данными:

```tsx
// ❌ Императивный подход - ручное управление данными
function CreditApplicationForm() {
  const [form] = useState(() => createForm(...));

  // Ручная загрузка данных
  useEffect(() => {
    fetch('/api/application/123')
      .then(res => res.json())
      .then(data => {
        // Вручную устанавливаем значение каждого поля
        form.field('loanAmount').setValue(data.loanAmount);
        form.field('loanTerm').setValue(data.loanTerm);
        form.field('loanType').setValue(data.loanType);
        // ... для каждого поля
      });
  }, []);

  // Ручное автосохранение
  useEffect(() => {
    const interval = setInterval(() => {
      const data = {
        loanAmount: form.field('loanAmount').value.value,
        loanTerm: form.field('loanTerm').value.value,
        // ... извлекаем каждое поле
      };
      fetch('/api/save', {
        method: 'POST',
        body: JSON.stringify(data)
      });
    }, 30000);

    return () => clearInterval(interval);
  }, []);

  // Это быстро становится неуправляемым!
}
```

Используйте встроенные механизмы управления потоком данных:

```tsx
// ✅ Декларативный подход - структурированный поток данных
function CreditApplicationForm({ applicationId }) {
  const form = useMemo(() => createCreditApplicationForm(), []);

  // Загрузка данных
  useEffect(() => {
    if (applicationId) {
      loadApplication(applicationId).then((data) => {
        form.patchValue(data);
      });
    }
  }, [applicationId]);

  // Автосохранение
  useAutoSave(form, {
    saveFn: (data) => saveDraft(data),
    debounce: 30000,
  });

  return <FormRenderer form={form} />;
}
```

Преимущества:
- **Меньше кода** - Нет ручных операций с отдельными полями
- **Типобезопасность** - Полная поддержка TypeScript
- **Автоматизация** - Поведения пересчитываются, валидация повторяется
- **Эффективность** - Обновляются только изменённые поля
- **Надёжность** - Автоматически обрабатывает граничные случаи

## Сценарии потока данных

Наша форма кредитного заявления имеет несколько реальных сценариев:

### 1. Новое заявление
- Форма начинается пустой
- Пользователь заполняет с нуля
- Автосохранение сохраняет прогресс
- Может быть сохранено как черновик

### 2. Редактирование черновика
- Загрузка сохранённого черновика
- Пользователь продолжает заполнение
- Автосохранение обновляет черновик
- Может быть отправлено при завершении

### 3. Редактирование отправленного заявления
- Загрузка отправленного заявления
- Некоторые поля могут быть только для чтения
- Изменения обновляют заявление
- Ведётся журнал аудита

### 4. Предзаполнение из профиля
- Загрузка данных профиля пользователя
- Автоматическое заполнение личных данных
- Автоматическое заполнение контактной информации
- Пользователь может изменить любое поле

## Что мы будем реализовывать

К концу этого раздела наша форма будет иметь:

### Загрузка
- ✅ Загрузка заявления из API
- ✅ Загрузка черновика из localStorage
- ✅ Обработка состояний загрузки (загрузка, ошибка, успех)
- ✅ Приоритет: API > localStorage > по умолчанию

### Автосохранение
- ✅ Автосохранение каждые 30 секунд
- ✅ Сохранение при выгрузке страницы
- ✅ Показ индикатора состояния сохранения
- ✅ Сохранение в localStorage и/или API

### Управление черновиками
- ✅ Создание нового черновика
- ✅ Список всех черновиков
- ✅ Загрузка конкретного черновика
- ✅ Обновление текущего черновика
- ✅ Удаление черновика

### Сброс и очистка
- ✅ Возврат к исходным значениям
- ✅ Очистка всех данных
- ✅ Сброс определённого этапа
- ✅ Диалоги подтверждения

### Предзаполнение
- ✅ Загрузка из профиля пользователя
- ✅ Выборочное предзаполнение полей
- ✅ Умное объединение (не перезаписываем заполненные поля)
- ✅ Ручное срабатывание предзаполнения

### Преобразование
- ✅ Сериализация для API (Date → ISO строка)
- ✅ Десериализация из API (ISO строка → Date)
- ✅ Нормализация данных (обрезка, нижний регистр, форматирование)
- ✅ Удаление вычисляемых полей

## Жизненный цикл данных формы

Понимание полного потока данных:

```
┌─────────────────────────────────────────────────────────────┐
│                    Жизненный цикл данных формы              │
└─────────────────────────────────────────────────────────────┘

1. ЗАГРУЗКА
   ├─ API: Загрузка отправленного/черновика заявления
   ├─ localStorage: Загрузка сохранённого черновика
   ├─ Profile: Предзаполнение из данных пользователя
   └─ Default: Пустая форма
                ↓
2. ПРЕОБРАЗОВАНИЕ (Десериализация)
   ├─ ISO строки → Объекты Date
   ├─ Форматирование номеров телефонов для отображения
   └─ Подготовка к использованию в форме
                ↓
3. ПАТЧИРОВАНИЕ ФОРМЫ
   ├─ form.patchValue(data)
   ├─ Поведения пересчитываются
   └─ Валидация выполняется
                ↓
4. РЕДАКТИРОВАНИЕ ПОЛЬЗОВАТЕЛЕМ
   ├─ Изменения полей
   ├─ Поведения реагируют
   └─ Валидация проверяет
                ↓
5. АВТОСОХРАНЕНИЕ
   ├─ С задержкой (каждые 30 сек)
   ├─ Преобразование (Сериализация)
   └─ Сохранение в localStorage/API
                ↓
6. ОТПРАВКА
   ├─ Валидация всей формы
   ├─ Преобразование (Сериализация)
   └─ Отправка на API
```

## Структура файлов

Мы создадим такую структуру:

```
src/
├── services/
│   ├── api/
│   │   ├── application.api.ts       # Операции CRUD заявления
│   │   └── user-profile.api.ts      # API профиля пользователя
│   ├── storage/
│   │   └── draft.storage.ts         # localStorage для черновиков
│   ├── auto-save.service.ts         # Сервис автосохранения
│   └── data-transform.service.ts    # Преобразование данных
│
├── hooks/
│   ├── useAutoSave.ts               # Хук автосохранения
│   ├── useDraftManager.ts           # Хук управления черновиками
│   ├── useDataLoader.ts             # Хук загрузки данных
│   ├── useFormReset.ts              # Хук сброса/очистки
│   └── useDataPrefill.ts            # Хук предзаполнения
│
└── components/
    ├── CreditApplicationForm.tsx    # Основная форма с потоком данных
    ├── AutoSaveIndicator.tsx        # UI статуса сохранения
    ├── DraftSelector.tsx            # UI списка черновиков
    └── ControlPanel.tsx             # UI управления формой
```

## Основные концепции

### 1. patchValue vs setValue

```typescript
// patchValue - обновляет несколько полей одновременно
form.patchValue({
  loanAmount: 500000,
  loanTerm: 120,
  loanType: 'mortgage'
});

// setValue - обновляет одно поле
form.field('loanAmount').setValue(500000);
```

### 2. Observable подписки

```typescript
// Подписка на изменения значения формы
const subscription = form.value.subscribe((value) => {
  console.log('Форма изменилась:', value);
});

// Очистка
return () => subscription.unsubscribe();
```

### 3. Состояние формы

```typescript
form.value.value      // Текущие данные формы
form.isDirty.value    // Была ли форма изменена?
form.isValid.value    // Форма валидна?
form.errors.value     // Все ошибки валидации
```

### 4. Преобразователи

```typescript
const transformer = {
  serialize: (formData) => apiData,      // Форма → API
  deserialize: (apiData) => formData,    // API → Форма
};
```

## Интеграция с поведениями и валидацией

Поток данных работает полностью с тем, что мы уже построили:

### После загрузки данных

```typescript
// Загрузка данных
form.patchValue(applicationData);

// Поведения автоматически:
// - Вычисляют процентную ставку
// - Вычисляют ежемесячный платёж
// - Показывают/скрывают условные поля
// - Вычисляют общий доход

// Валидация автоматически:
// - Проверяет все загруженные значения
// - Показывает ошибки для некорректных данных
// - Переваляидирует при изменении зависимостей
```

### Во время автосохранения

```typescript
// Получение текущего состояния формы
const data = form.value.value;

// Вычисляемые поля включаются автоматически
// - fullName (из firstName + lastName)
// - age (из birthDate)
// - totalIncome (из income + additionalIncome)

// Мы удалим их во время преобразования
```

## Начало работы

Давайте начнём с **Загрузки начальных данных** - основы потока данных. Это охватывает:
- Создание сервисов API
- Загрузку данных заявления
- Загрузку черновиков из localStorage
- Обработку состояний загрузки
- Выбор приоритета источника данных

В следующем разделе мы:
1. Создадим сервис API для приложений
2. Создадим хук для загрузки данных
3. Интегрируем с компонентом формы
4. Обработаем состояния загрузки, ошибки и успеха
5. Протестируем сценарии загрузки

Готовы? Начнём!
