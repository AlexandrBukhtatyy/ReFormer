---
sidebar_position: 1
---

# Введение в отправку формы

Понимание полного жизненного цикла отправки формы от валидации до ответа сервера.

## Что такое отправка формы?

Отправка формы - это последний этап жизненного цикла формы, где валидированные данные отправляются на сервер:

- **Валидация перед отправкой** - Убедитесь, что все данные корректны перед отправкой
- **Преобразование данных** - Преобразование данных формы в формат API
- **Сетевой запрос** - Отправка данных на сервер
- **Обработка ответа** - Обработка успешных или ошибочных ответов
- **Управление состоянием** - Обновление интерфейса в зависимости от статуса отправки
- **Восстановление после ошибок** - Обработка сбоев и включение повторной попытки

## Почему правильное управление отправкой?

Вместо ручной обработки каждого аспекта отправки:

```tsx
// ❌ Императивный подход - ручная обработка отправки
const handleSubmit = async () => {
  // Ручная валидация
  const errors = [];
  if (!formData.loanAmount) errors.push('Сумма кредита требуется');
  if (!formData.loanTerm) errors.push('Срок кредита требуется');
  if (errors.length > 0) {
    setErrors(errors);
    return;
  }

  // Ручное преобразование
  const apiData = {
    loanAmount: formData.loanAmount,
    loanTerm: formData.loanTerm,
    // ... вручную сопоставить каждое поле
  };

  // Ручная отправка
  setSubmitting(true);
  setError(null);

  try {
    const response = await fetch('/api/applications', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(apiData),
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message);
    }

    const result = await response.json();
    setSuccess(true);
    navigate(`/success?id=${result.id}`);
  } catch (error) {
    setError(error.message);
  } finally {
    setSubmitting(false);
  }
};
```

Используйте встроенный механизм отправки ReFormer:

```tsx
// ✅ Декларативный подход - структурированная отправка
const handleSubmit = async () => {
  try {
    // form.submit() автоматически:
    // 1. Валидирует все поля
    // 2. Выбросит ошибку, если невалидно
    // 3. Вызовет callback с корректными данными
    const result = await form.submit(async (data) => {
      // Преобразуем и отправляем
      const apiData = transformer.serialize(data);
      return await submitApplication(apiData);
    });

    // Обработка успеха
    navigate(`/success?id=${result.id}`);
  } catch (error) {
    // Обработка ошибки
    showNotification('Отправка не удалась');
  }
};
```

Преимущества:
- **Автоматическая валидация** - Не нужны ручные проверки
- **Типобезопасность** - Полная поддержка TypeScript
- **Четкое разделение** - Валидация, преобразование и отправка - отдельные задачи
- **Обработка ошибок** - Встроенные типы ошибок и обработка
- **Управление состоянием** - Интегрировано с состоянием формы

## Жизненный цикл отправки

Понимание полного потока от нажатия кнопки до ответа сервера:

```
┌─────────────────────────────────────────────────────────────┐
│                   Жизненный цикл отправки                    │
└─────────────────────────────────────────────────────────────┘

1. ПОЛЬЗОВАТЕЛЬ НАЖИМАЕТ ОТПРАВКУ
   ↓
2. ПРЕДВАРИТЕЛЬНАЯ ВАЛИДАЦИЯ
   ├─ Запустить все валидаторы (синхронные + асинхронные)
   ├─ Проверить обязательные поля
   ├─ Проверить условную валидацию
   └─ Если невалидно → Показать ошибки, СТОП
   ↓
3. ПОДГОТОВКА ДАННЫХ
   ├─ Получить текущие значения формы
   ├─ Применить преобразования (сериализация)
   ├─ Удалить вычисляемые поля
   └─ Форматировать для API
   ↓
4. СОСТОЯНИЕ ОТПРАВКИ
   ├─ Установить form.isSubmitting = true
   ├─ Отключить кнопку отправки
   └─ Показать индикатор загрузки
   ↓
5. СЕТЕВОЙ ЗАПРОС
   ├─ Отправить POST/PUT запрос
   ├─ Включить заголовки аутентификации
   └─ Ждать ответ
   ↓
6. ОБРАБОТКА ОТВЕТА
   ├─ Успех (2xx)
   │   ├─ Отметить форму как отправленную
   │   ├─ Очистить черновик
   │   └─ Перейти на страницу успеха
   │
   ├─ Ошибка валидации (422)
   │   ├─ Сопоставить ошибки полям
   │   ├─ Показать ошибки уровня поля
   │   └─ Оставить форму редактируемой
   │
   ├─ Ошибка сервера (5xx)
   │   ├─ Показать сообщение об ошибке
   │   ├─ Включить повторную попытку
   │   └─ Сохранить данные формы
   │
   └─ Ошибка сети
       ├─ Показать сообщение об отсутствии соединения
       ├─ Автоматическая повторная попытка с отступлением
       └─ Сохранить черновик локально
   ↓
7. ОБНОВЛЕНИЕ СОСТОЯНИЯ
   ├─ Установить form.isSubmitting = false
   ├─ Обновить статус отправки
   └─ Повторно включить взаимодействия
```

## Сценарии отправки

Наша форма заявки на кредит обрабатывает различные сценарии реального мира:

### 1. Простая отправка
- Пользователь заполняет все обязательные поля
- Нажимает отправку
- Форма валидируется и отправляется
- Сообщение об успехе и перенаправление

### 2. Ошибка валидации
- Пользователь нажимает отправку с ошибками
- Валидация на клиенте уловит проблемы
- Ошибки показаны на полях
- Отправка заблокирована до исправления

### 3. Валидация на сервере
- Форма прошла валидацию на клиенте
- Сервер обнаруживает дополнительные проблемы
- Сервер возвращает ошибки для конкретных полей
- Ошибки сопоставлены полям формы

### 4. Ошибка сети с повторной попыткой
- Форма успешно отправляется
- Соединение сети разрывается
- Автоматическая повторная попытка с отступлением
- Доступна кнопка повторной попытки вручную

### 5. Оптимистичное обновление
- Форма отправляется
- Интерфейс обновляется немедленно (оптимистично)
- Если сервер возвращает ошибку, откатить
- Если успех, подтвердить обновление

### 6. Многошаговая отправка
- Валидировать каждый шаг отдельно
- Финальный шаг отправляет всю форму
- Может вернуться для редактирования предыдущих шагов
- Страница проверки перед финальной отправкой

## Что мы будем реализовывать

К концу этого раздела наша заявка на кредит будет иметь:

### Базовая отправка
- ✅ Отправка с автоматической валидацией
- ✅ Преобразование данных перед отправкой
- ✅ Обработка успешного ответа
- ✅ Обработка ошибочного ответа

### Управление состоянием
- ✅ Состояния отправки (ожидание, отправка, успех, ошибка)
- ✅ Индикаторы загрузки
- ✅ Отключенное состояние во время отправки
- ✅ Отслеживание прогресса

### Обработка ошибок
- ✅ Ошибки валидации на клиенте
- ✅ Ошибки валидации на сервере
- ✅ Ошибки сети
- ✅ Общие ошибки сервера
- ✅ Стратегии восстановления после ошибок

### Продвинутые функции
- ✅ Логика повторной попытки с экспоненциальным отступлением
- ✅ Оптимистичные обновления интерфейса
- ✅ Многошаговый рабочий процесс отправки
- ✅ Диалоги подтверждения
- ✅ Обратные вызовы успеха/ошибки
- ✅ Навигация после отправки

## Интеграция с предыдущими разделами

Отправка строится на всем, что мы создали:

### Поведения (автоматически)
```typescript
// Вычисляемые поля включаются автоматически
const data = form.value.value;
// {
//   loanAmount: 500000,
//   interestRate: 8.5,        // ← Вычислено поведением
//   monthlyPayment: 3845,     // ← Вычислено поведением
//   age: 35,                  // ← Вычислено поведением
// }
```

### Валидация (автоматически)
```typescript
// form.submit() валидирует перед отправкой
await form.submit(async (data) => {
  // Этот callback запустится только если валидация прошла успешно
  return await sendToServer(data);
});
```

### Поток данных (вручную)
```typescript
// Преобразовать перед отправкой
const result = await form.submit(async (data) => {
  // Использовать трансформатор из раздела Поток данных
  const apiData = transformer.serialize(data);
  return await submitApplication(apiData);
});

// Очистить черновик после успеха
if (result.success) {
  deleteDraft(draftId);
}
```

## Структура файлов

Мы создадим эту структуру для отправки:

```
src/
├── services/
│   ├── api/
│   │   └── submission.api.ts        # API для отправки заявок
│   ├── submission.service.ts        # Сервис отправки с повторной попыткой
│   └── optimistic.service.ts        # Утилиты оптимистичного обновления
│
├── hooks/
│   ├── useSubmission.ts             # Основной хук отправки
│   ├── useSubmissionState.ts        # Управление состоянием
│   ├── useRetry.ts                  # Логика повторной попытки
│   └── useOptimistic.ts             # Оптимистичные обновления
│
├── components/
│   ├── CreditApplicationForm.tsx    # Форма с отправкой
│   ├── SubmitButton.tsx             # Кнопка отправки с состояниями
│   ├── SubmissionStatus.tsx         # Индикатор статуса
│   ├── RetryIndicator.tsx           # Прогресс повторной попытки
│   ├── ConfirmationDialog.tsx       # Подтверждение отправки
│   └── SuccessPage.tsx              # Успех после отправки
│
└── errors/
    ├── ValidationError.ts           # Тип ошибки валидации
    ├── ServerError.ts               # Тип ошибки сервера
    └── NetworkError.ts              # Тип ошибки сети
```

## Ключевые концепции

### 1. form.submit()

Основной метод отправки:

```typescript
const result = await form.submit(async (validData) => {
  // Этот callback получает валидированные данные
  // Верните результат вашего API
  return await apiCall(validData);
});
```

**Ключевые точки**:
- Автоматически валидирует перед callback
- Выбрасывает если валидация не пройдена
- Callback получает только валидные данные
- Возвращает то, что вернул callback

### 2. Состояния отправки

Отслеживайте статус отправки:

```typescript
type SubmissionState =
  | { status: 'idle' }                    // Не отправлено
  | { status: 'submitting' }              // В процессе
  | { status: 'success'; data: T }        // Успешно
  | { status: 'error'; error: Error }     // Не удалось
```

### 3. Типы ошибок

Различные ошибки требуют различной обработки:

```typescript
// Ошибка валидации - пользователь может исправить
class ValidationError extends Error {
  fields: Array<{ field: string; message: string }>;
}

// Ошибка сервера - может быть временной
class ServerError extends Error {
  code: string;
  retryable: boolean;
}

// Ошибка сети - определенно временная
class NetworkError extends Error {
  retryable: true;
}
```

### 4. Трансформаторы

Преобразование между форматами формы и API:

```typescript
const transformer = {
  serialize: (formData) => {
    // Форма → API
    return {
      loan_amount: formData.loanAmount,
      loan_term: formData.loanTerm,
      // ... формат API
    };
  },
  deserialize: (apiData) => {
    // API → Форма
    return {
      loanAmount: apiData.loan_amount,
      loanTerm: apiData.loan_term,
      // ... формат формы
    };
  },
};
```

## Общие паттерны

### Базовая отправка
```typescript
await form.submit(async (data) => {
  return await api.submit(data);
});
```

### Отправка с преобразованием
```typescript
await form.submit(async (data) => {
  const transformed = transformer.serialize(data);
  return await api.submit(transformed);
});
```

### Отправка с состоянием
```typescript
const [submitting, setSubmitting] = useState(false);

try {
  setSubmitting(true);
  await form.submit(submitFn);
} finally {
  setSubmitting(false);
}
```

### Отправка с повторной попыткой
```typescript
let attempts = 0;
while (attempts < maxAttempts) {
  try {
    return await form.submit(submitFn);
  } catch (error) {
    if (!isRetryable(error)) throw error;
    attempts++;
    await sleep(exponentialBackoff(attempts));
  }
}
```

## Начало работы

Начнем с **базовой отправки** - основы отправки форм. Это охватывает:
- Использование `form.submit()`
- Создание API сервиса
- Обработка валидации
- Успешные и ошибочные ответы
- Состояния кнопки отправки

В следующем разделе мы:
1. Создадим API сервис отправки
2. Реализуем базовый обработчик отправки
3. Добавим кнопку отправки с состоянием загрузки
4. Обработаем успешные и ошибочные ответы
5. Протестируем поток отправки

Готовы? Начинаем!
